# Сценарии интеграции

Система предлагает различные варианты интеграции от очень простого до бесконечно функционального в зависимости от требований.

## Платежная форма 

### Виджет с уведомлением о принятых платежах по электронной почте

Если вам не требуется проверять платежи перед оплатой и фиксировать факт после оплаты:

* Пропишите на свой сайт [[скрипт установки виджета]]().
* Настройте в [[личном кабинете]]() e-mail адрес для уведомлений о платежах

## Регистрация платежей

### Виджет с регистрацией платежей

Если вам необходимо регистрировать платежи в своей системе, но нет необходимости проверять перед оплатой, то ваши действия следующие:  

1. Пропишите на свой сайт [[скрипт установки виджета]]().
2. Настройте регистрацию платежей

* Создайте скрипт обработки [[Pay уведомления]](), например,  `https://site.ru/webhooks/cloudpayments/pay`
* Пропишите в обработчике логику регистрации платежей и ответ в JSON формате
* Включите в [[личном кабинете]]() отправку Pay уведомлений

## Проверка и регистрация платежей

### Виджет с проверкой и регистрацией платежей

Если вам необходимо проверять и регистрировать платежи в своей системе, ваши действия следующие:

1. Пропишите на свой сайт скрипт установки виджета.
2. Настройте проверку платежей
* Создайте скрипт обработки Check уведомления, например, `https://site.ru/webhooks/cloudpayments/check`
* Пропишите в обработчике логику проверки платежей и ответ в JSON формате
3. Настройте регистрацию платежей
* Создайте скрипт обработки Pay уведомления, например, `https://site.ru/webhooks/cloudpayments/pay`
* Пропишите в обработчике логику регистрации платежей и ответ в JSON формате
4. Включите в личном кабинете отправку Check и Pay уведомлений

## Автоплатежи для интернет-провайдеров

### Оплата через виджет с указанием номера абонента, суммы платежа и созданием подписки на регулярные платежи

Платежное решение подходит для интернет-провайдеров, операторов связи и телекомов. Уведомления на проверку и регистрацию платежей могут быть настроены как в формате CloudPayments, так и в формате QIWI (ОСМП).

<p><a href="pages/widget.html" target="_blank">Пример формы</a></p>

<!--<iframe src="pages/widget.html" width="600" height="300" align="top" seamless></iframe>-->

Код формы:

```shell
//note: в примере используется библиотека jquery

this.paySample3 = function () {
    var widget = new cp.CloudPayments();

    var data = {};
    var auto = $('#recurrent-sample-3').is(':checked'); //проверка

    if (auto) { //включаем подписку

        var date = new Date(); //текущая дата
        date.setMonth(date.getMonth() + 1); //следующий месяц
        date.setDate(date.getDate() - 1); //минус один день

        var recurrent = { interval: 'Month', period: 1, startDate: date }; //один раз в месяц начиная со следующего месяца за минусом одного дня
        data.cloudPayments = {
            recurrent: recurrent
        }
    }

    var amount = parseFloat($('#amount-sample-3').val());
    var accountId = $('#account-sample-3').val();

    widget.charge({ // options
        publicId: 'test_api_00000000000000000000002', //id из личного кабинета
        description: 'Пополнение счета абонента ' + accountId, //назначение
        amount: amount, //сумма
        currency: 'RUB', //валюта
        accountId: accountId, //идентификатор плательщика (обязательно для создания подписки)
        data: data
    },
    function (options) { // success
        //действие при успешной оплате
    },
    function (reason, options) { // fail
        //действие при неуспешной оплате
    });
};

$('#checkout-sample-3').click(paySample3);
```

## Автоплатежи для благотворительных фондов

### Оплата через виджет с указанием имени, фамилии, e-mail адреса и номера телефона плательщика, а также созданием подписки на регулярные платежи

Платежное решение подходит для благотворительных фондов. Имя, фамилия, телефон, e-mail и любые другие данные с формы будут сохранены в виджете и переданы на ваш сервер через [[PAY уведомление]]().

<p><a href="pages/widget2.html" target="_blank">Пример формы</a></p>

Код формы:

```shell
//note: в примере используется библиотека jquery

this.paySample4 = function () {
    var widget = new cp.CloudPayments();

    var data = { //данные дарителя
        name: $('#name-sample-4').val(),
        lastName: $('#lastName-sample-4').val(),
        phone: $('#phone-sample-4').val()
    };

    var auto = $('#recurrent-sample-4').is(':checked'); //проверка

    if (auto) { //включаем подписку
        data.cloudPayments = {
            recurrent: { interval: 'Month', period: 1 } //один раз в месяц начиная со следующего месяца
        }
    }

    var amount = parseFloat($('#amount-sample-4').val());
    var accountId = $('#email-sample-4').val();

    widget.charge({ // options
        publicId: 'test_api_00000000000000000000002', //id из личного кабинета
        description: 'Пожертвование в фонд ...', //назначение
        amount: amount, //сумма
        currency: 'RUB', //валюта
        accountId: accountId, //идентификатор плательщика (обязательно для создания подписки)
        email: accountId,
        data: data
    },
    function (options) { // success
        //действие при успешной оплате
    },
    function (reason, options) { // fail
        //действие при неуспешной оплате
    });
};

$('#checkout-sample-4').click(paySample4);
```

## Оплата в рассрочку

### Оплата через виджет с рассрочкой платежа на несколько месяцев

Платежное решение подходит для компаний, продающих товары и услуги с возможностью оплаты целиком или в рассрочку.



<br><iframe src="pages/widget3.html" width="600" height="150" align="top" seamless frameborder="1"></iframe>


Код формы:

```shell
//note: в примере используется библиотека jquery

this.paySample5 = function () {
    var widget = new cp.CloudPayments();

    var amount = 12000; //по умолчанию 12000 рублей разом
    var data = {};

    var payLater = $('#select-sample-5-later').is(':checked'); //проверка

    if (payLater) { //включаем подписку
        data.cloudPayments = {
            recurrent: { interval: 'Month', period: 1, amount: 1000, maxPeriods: 6 } //6 месяцев по 1000 рублей начиная со следующего месяца
        };
        amount = 6000; //сумма первого платежа - 6000 рублей.
    }

    widget.charge({ // options
        publicId: 'test_api_00000000000000000000002', //id из личного кабинета
        description: 'Оплата ...', //назначение
        amount: amount, //сумма
        currency: 'RUB', //валюта
        accountId: 'user@example.com', //идентификатор плательщика (обязательно для создания подписки)
        data: data
    },
    function (options) { // success
        //действие при успешной оплате
    },
    function (reason, options) { // fail
        //действие при неуспешной оплате
    });
};

$('#checkout-sample-5').click(paySample5);
```

## Рекуррентные платежи 

### Рекуррентные платежи с личным кабинетом плательщика

Если вам нужно брать с ваших покупателей плату на регулярной основе, по расписанию, сценарий может быть следующим:

- На вашем сайте необходима авторизация пользователей с доступом в личный кабинет. 
- Перед созданием плана подписки, проинформируйте пользователя о тарифном плане, периодичности платежей и предложите указать карточные данные.  
![recurring1](images/recurring1.png)  
Если пользователь согласится, сохраните после оплаты в его профиле маску карты (тип и последние 4 цифры), а также токен. Параметры карты и токен система возвращает в [[Pay]]() уведомлении и через API. Обязательным условием получения токена является передача идентификатора пользователя в параметре `AccountId`.
- При последующих оплатах, предлагайте пользователю оплатить с ранее привязанной карты 
![recurring2](images/recurring2.png)  
Если пользователь выбирает ранее использованную карту — вызывайте метод [[оплаты по токену]]() через API.
- Предоставьте пользователю возможность управлять своими картами.
![recurring3](images/recurring3.png)  
Если пользователь не желает более платить с привязанной карты, удалите маску и токен из его профиля. 
- Сделайте раздел с историей платежей, которая включает в себя как минимум дату и сумму оплаты.




